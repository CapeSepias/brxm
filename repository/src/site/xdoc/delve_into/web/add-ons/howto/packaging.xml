<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE document PUBLIC
  "-//Apache Software Foundation//DTD XDOC 1.0//EN"
  "http://maven.apache.org/dtd/xdoc_1_0.dtd">
<!--
  Copyright 2008 Hippo

  Licensed under the Apache License, Version 2.0 (the  "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS"
  BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<document>
  <properties>
      <title>Custom packaging</title>
  </properties>
  <body>
    <section name="Creating your own WAR package">

      <span class="shortdesc">Package Hippo CMS with your own add-on.</span>

      <p>
        In <a href="editing_template.html">Creating an Editing Template Add-on </a>
        we created an add-on containing a custom document type.
        We installed the add-on as a JAR in the local Maven repository.
        It would be nice if we could include our add-on with a custom
        packaged Hippo CMS WAR.
      </p>
    </section>
    <section name="Your own POM file">
      <p>
        All there is to creating your own WAR file is some modifications to the
        POM file (of your add-on project).
      </p>
      <p>
        <b>Note:</b> It is assumed that you have a project with a POM file
        similar to the one created in
        <a href="editing_template.html">Creating an Editing Template Add-on </a>.
        Follow that guide first if you don't have such a project and POM file.
      </p>

      <subsection name="Make your project a WAR project">
        <p>
          In <a href="editing_template.html">Creating an Editing Template Add-on </a>
          you created a JAR project. Change the packaging in pom.xml from "jar" to
          "war":
        </p>
        <source><![CDATA[<packaging>war</packaging>]]></source>
      </subsection>

      <subsection name="Add the WAR dependency">
        <p>
          Add a dependencies section in your POM file and in it add a dependency to the Hippo CMS Quickstart WAR:
        </p>
        <source><![CDATA[
 <dependencies>
  <dependency>
   <groupId>org.hippoecm</groupId>
   <artifactId>hippo-ecm-quickstart-war</artifactId>
   <version>${dependency_version}</version>
   <type>war</type>
   <scope>runtime</scope>
  </dependency>
 </dependencies>
]]></source>
      </subsection>
      <subsection name="Configure the WAR overlay">
        <p>
         Add a build section in your POM file and in it a plugins section. In the plugins section
         configure the maven war plugin to use the Quickstart WAR as an
          <a href='http://maven.apache.org/plugins/maven-war-plugin/overlays.html'>overlay</a>:
        </p>
        <source><![CDATA[
 <build>
  <plugins>
   <plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-war-plugin</artifactId>
    <version>2.1-alpha-1</version>
    <configuration>
     <overlays>
      <overlay>
       <groupId>org.hippoecm</groupId>
       <artifactId>hippo-ecm-quickstart-war</artifactId>
      </overlay>
     </overlays>
    </configuration>
   </plugin>
  </plugins>
 </build>
]]></source>
      <p>
        That's it. Running <b>mvn install</b> will create a custom WAR of your own plugin project and store it in the Maven repository.
      </p>
      </subsection>
      <subsection name="Troubleshooting">
        <p>
          If Maven is unable to find the Quickstart WAR, add the Hippo Maven 2 repository
          to pom.xml:
        </p>
<source><![CDATA[
<repositories>
  <repository>
    <id>hippoecm</id>
    <name>Hippo ECM maven 2 repository.</name>
    <url>http://repository.hippocms.org/maven2/</url>
    <snapshots>
      <enabled>true</enabled>
    </snapshots>
    <releases>
      <updatePolicy>never</updatePolicy>
    </releases>
    <layout>default</layout>
  </repository>
</repositories>
]]></source>
      </subsection>
    </section>
    <section name="Add the Jetty plugin for fast testing">
      <p>
        While developing your plugin you will probably what to test your work a lot. So lets take a moment to make 
        that easy. You can add the Jetty plugin to your POM file which will make it very easy to get your plugin 
        up and running fast.
      </p>
      <p>
        Add the following plugin section to your plugins section in your pom file.
        You will now be able to test drive your war with <b>mvn jetty:run-war</b>.
      </p>
      <source><![CDATA[
   <plugin>
    <groupId>org.mortbay.jetty</groupId>
    <artifactId>maven-jetty-plugin</artifactId>
    <version>6.1.10</version>
    <configuration>
     <scanIntervalSeconds>5</scanIntervalSeconds>
     <connectors>
      <connector implementation="org.mortbay.jetty.nio.SelectChannelConnector">
       <port>8080</port>
      </connector>
     </connectors>
     <contextPath>/cms</contextPath>
    </configuration>
    <dependencies>
     <!-- atomikos dependecies for running jetty:run[-war|-exploded] -->
     <dependency>
      <groupId>com.atomikos</groupId>
      <artifactId>transactions-api</artifactId>
      <version>3.1.4</version>
      <scope>runtime</scope>
     </dependency>
     <dependency>
      <groupId>com.atomikos</groupId>
      <artifactId>transactions-jta</artifactId>
      <version>3.1.4</version>
      <scope>runtime</scope>
     </dependency>
     <dependency>
      <groupId>com.atomikos</groupId>
      <artifactId>transactions</artifactId>
      <version>3.1.4</version>
      <scope>runtime</scope>
     </dependency>
     <dependency>
      <groupId>com.atomikos</groupId>
      <artifactId>atomikos-util</artifactId>
      <version>3.1.4</version>
      <scope>runtime</scope>
     </dependency>
    </dependencies>
   </plugin>
]]></source>
    </section>

    <section name="Full pom.xml">
      <p>
        If you followed all the steps in this guide, your POM file should look
        similar to this:
      </p>
<source><![CDATA[
<?xml version="1.0" encoding="UTF-8"?>
<project 
  xmlns="http://maven.apache.org/POM/4.0.0" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">

  <modelVersion>4.0.0</modelVersion>
  <name>Editing Template Add-on</name>
  <description>Editing Template Add-on</description>
  <groupId>org.example</groupId>
  <artifactId>editing-template-addon</artifactId>
  <version>1.01.00</version>
  <packaging>war</packaging>

  <dependencies>
    <dependency>
      <groupId>org.hippoecm</groupId>
      <artifactId>hippo-ecm-quickstart-war</artifactId>
      <version>2.01.00.14266</version>
      <type>war</type>
      <scope>runtime</scope>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-war-plugin</artifactId>
        <version>2.1-alpha-1</version>
        <configuration>
          <overlays>
            <overlay>
              <groupId>org.hippoecm</groupId>
              <artifactId>hippo-ecm-quickstart-war</artifactId>
            </overlay>
          </overlays>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.mortbay.jetty</groupId>
        <artifactId>maven-jetty-plugin</artifactId>
        <version>6.1.10</version>
        <configuration>
          <scanIntervalSeconds>5</scanIntervalSeconds>
          <connectors>
            <connector implementation="org.mortbay.jetty.nio.SelectChannelConnector">
            <port>8080</port>
            </connector>
          </connectors>
          <contextPath>/cms</contextPath>
        </configuration>
        <dependencies>
          <!-- atomikos dependecies for running jetty:run[-war|-exploded] -->
          <dependency>
            <groupId>com.atomikos</groupId>
            <artifactId>transactions-api</artifactId>
            <version>3.1.4</version>
            <scope>runtime</scope>
          </dependency>
          <dependency>
            <groupId>com.atomikos</groupId>
            <artifactId>transactions-jta</artifactId>
            <version>3.1.4</version>
            <scope>runtime</scope>
          </dependency>
          <dependency>
            <groupId>com.atomikos</groupId>
            <artifactId>transactions</artifactId>
            <version>3.1.4</version>
            <scope>runtime</scope>
          </dependency>
          <dependency>
            <groupId>com.atomikos</groupId>
            <artifactId>atomikos-util</artifactId>
            <version>3.1.4</version>
            <scope>runtime</scope>
          </dependency>
        </dependencies>
      </plugin>

    </plugins>

  </build>

  <repositories>
    <repository>
      <id>hippoecm</id>
      <name>Hippo ECM maven 2 repository.</name>
      <url>http://repository.hippocms.org/maven2/</url>
      <snapshots>
        <enabled>true</enabled>
      </snapshots>
      <releases>
        <updatePolicy>never</updatePolicy>
      </releases>
      <layout>default</layout>
    </repository>
  </repositories>

</project>
]]></source>
    </section>

  </body>
</document>
